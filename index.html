<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Launch Pad R1</title>
    <style>
        :root {
            --bg-color: #0d0d0d;
            --font-color: #e0e0e0;
            --primary-color: #ff7043; /* Rabbit R1 Orange */
            --border-color: #2a2a2a;
            --item-bg: #1c1c1c;
            --icon-color: #7a7a7a; /* Slightly darker inactive color */
            --font-family: 'SF Pro Text', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        *, *::before, *::after {
            box-sizing: border-box;
        }
        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--font-color);
            font-size: 15px; /* Base font size for smaller display */
            margin: 0;
        }
        .main-view {
            width: 100%;
            max-width: 480px;
            min-width: 240px;
            margin: 0 auto;
            padding: var(--rabbit-safe-area-inset-top, 20px) 8px 8px;
        }
        header {
            position: relative;
            text-align: center;
            align-items: center;
            margin-bottom: 15px;
        }
        header img {
            max-width: 100%;
            height: 65px;
            object-fit: contain;
        }
        header #themeBtn {
            position: absolute;
            top: 0;
            right: 0;
            background: transparent;
            border: none;
            color: var(--primary-color);
            font-weight: bold;
            font-size: 0.9em;
            width: auto;
            height: auto;
            padding: 8px;
        }
        header #themeBtn:hover {
            background: var(--item-bg);
            filter: brightness(1.15);
        }
        .search-section {
            display: flex;
            gap: 4px;
            margin-bottom: 15px;
        }
        #searchBtn, #addBtn, #quickLaunchBtn {
            width: 38px; /* Make it a square icon button */
            padding: 7px; /* (38px button size - 24px icon size) / 2 */
        }
        #addBtn, #quickLaunchBtn {
            height: 38px; /* Ensure it's a perfect square */
        }
        #searchBtn svg, #addBtn svg, #quickLaunchBtn svg {
            width: 24px;
            height: 24px;
        }
        input[type="text"] {
            flex-grow: 1;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--item-bg);
            color: var(--font-color);
            font-size: 1em;
            min-width: 0; /* Fix for flexbox overflow */
        }
        button {
            padding: 8px 8px;
            border: none;
            background-color: var(--primary-color);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            flex-shrink: 0; /* Prevent buttons from shrinking in flex containers */
        }
        button:hover {
            filter: brightness(1.15);
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            filter: none;
        }
        /* Secondary button style for non-primary actions like 'Cancel' */
        button.secondary {
            background-color: var(--item-bg);
            border: 1px solid var(--border-color);
            color: var(--icon-color);
        }
        button.secondary:hover {
            background-color: #2c2c2c;
            color: var(--font-color);
            filter: none; /* Override the default button hover */
        }
        #linksList {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }
        .link-item {
            background-color: var(--item-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: nowrap;
        }
        .add-suggestion-item {
            cursor: pointer;
        }
        .add-suggestion-item:hover {
            background-color: #252525;
        }
        .web-search-item {
            justify-content: center;
            cursor: pointer;
        }
        .web-search-item:hover {
            background-color: #252525;
        }
        .web-search-item .link-description {
            text-align: center;
            width: 100%;
        }
        .web-suggestion .link-actions button {
            padding: 6px 12px;
            font-size: 1.1em;
        }
        .error-message {
            text-align: center;
            color: #e74c3c;
        }
        .link-display {
            flex-grow: 1;
            overflow: hidden;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: space-between;
            gap: 10px; /* Default large gap */
            cursor: pointer;
        }
        .link-favicon {
            width: 24px;
            height: 24px;
            flex-shrink: 0;
            background-color: #333;
            border-radius: 4px;
            object-fit: cover;
        }
        .link-info {
            flex-grow: 1;
            overflow: hidden; 
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .link-description {
            font-weight: bold;
            font-size: 0.95em; /* Default large font */
            cursor: pointer;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .link-actions {
            display: flex;
            gap: 10px;
            flex-direction: column;
            flex-shrink: 0;
        }
        /* For the horizontal icons in the normal link view */
        .link-display > .link-actions {
            flex-direction: row;
            gap: 10px; /* Default large gap */
        }
        .link-actions span {
            cursor: pointer;
            font-size: 1.1em;
            color: var(--icon-color);
        }
        .link-actions span:hover { color: var(--primary-color); }
        .link-actions svg {
            width: 18px;
            height: 18px;
            display: block;
        }
        .favorite-btn.is-favorite, .favorite-indicator {
            color: #FFD700; /* Gold, for high visibility across all themes */
        }
        /* Dynamic Sizing for Link Descriptions */
        #linksList.small-text .link-display { gap: 6px; }
        #linksList.small-text .link-description { font-size: 0.85em; }
        #linksList.small-text .link-display > .link-actions { gap: 6px; }
        #linksList.small-text .link-actions svg { width: 16px; height: 16px; }
        .category-header {
            font-size: 1em;
            font-weight: bold;
            color: var(--primary-color);
            margin-top: 15px;
            margin-bottom: 8px;
            padding-bottom: 5px;
            border-bottom: 1px solid var(--border-color);
        }
        #linksList > h3:first-of-type {
            margin-top: 0;
        }
        .link-info input, .link-info select {
            width: 100%;
            margin-top: 5px;
            padding: 6px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--item-bg);
            color: var(--font-color);
            font-size: 0.95em;
        }
        .link-info > *:first-child {
            margin-top: 0;
        }
.form-actions {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 10px;
}
.input-with-action {
    position: relative;
}
.input-with-action input {
    padding-right: 42px; /* Space for the button */
}
.input-with-action button {
    position: absolute;
    top: 50%;
    right: 5px;
    transform: translateY(-50%);
    width: 32px;
    height: 32px;
    padding: 5px;
    background: transparent;
    border: none;
    color: var(--icon-color);
}
.input-with-action button:hover {
    background-color: #3a3a3a;
    color: var(--font-color);
}
        .actions-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .list-actions {
            display: flex;
            align-items: center;
            /* A larger gap to visually separate view controls from the quick launch button */
            gap: 20px; 
        }
        #toggleAllLink {
            color: var(--icon-color);
            text-decoration: none;
            font-size: 0.9em;
        }
        #toggleAllLink:hover {
            color: var(--primary-color);
        }
        .app-actions {
            display: flex;
            gap: 8px;
        }
        .view-controls {
            display: flex;
            gap: 10px;
        }
        .view-btn {
            cursor: pointer;
        }
        .view-btn svg {
            display: block;
            width: 24px;
            height: 24px;
            fill: var(--icon-color);
        }
        .view-btn.active svg {
            fill: var(--primary-color);
        }
        /* Group View Styles */
        .category-header.collapsible {
            cursor: pointer;
            position: relative;
            padding-right: 20px; /* Space for arrow */
        }
        .category-header.collapsible::after {
            content: '▶';
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%) rotate(0deg);
            font-size: 0.8em;
            transition: transform 0.2s ease;
        }
        .category-header.collapsible.expanded::after {
            transform: translateY(-50%) rotate(90deg);
        }
        .links-container {
            display: none;
            padding-top: 5px;
        }
        .links-container.expanded {
            display: block;
        }
        /* Custom Prompt Styles */
        .custom-prompt-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 8px;
        }
        .custom-prompt-dialog {
            background-color: var(--item-bg);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            width: 100%;
            max-width: 320px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .custom-prompt-dialog p {
            margin: 0;
            font-weight: bold;
            text-align: center;
        }
        .custom-prompt-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }
        .custom-prompt-actions-right {
            display: flex;
            gap: 10px;
        }
        .custom-prompt-dialog select {
            width: 100%;
            padding: 6px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--item-bg);
            color: var(--font-color);
            font-size: 0.95em;
        }
        .custom-prompt-error {
            color: #e74c3c; /* A noticeable red */
            font-size: 0.9em;
            text-align: center;
            margin: -5px 0 5px 0;
            min-height: 1.2em; /* Prevent layout shift when message appears */
        }
    </style>
</head>
<body>
    <div id="mainView" class="main-view">
        <header>
            <img src="launchpad-logo.png" alt="Launch Pad R1 Logo">
            <button id="themeBtn" title="Change Theme">Theme!</button>
        </header>
        <div class="search-section">
            <input type="text" id="searchInput" placeholder="Search or Add...">
            <button id="searchBtn" title="Search with DuckDuckGo">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M18.031 16.617l4.283 4.282-1.415 1.415-4.282-4.283A8.96 8.96 0 0 1 11 20c-4.968 0-9-4.032-9-9s4.032-9 9-9 9 4.032 9 9a8.96 8.96 0 0 1-1.969 5.617zm-2.006-.742A6.977 6.977 0 0 0 18 11c0-3.868-3.133-7-7-7-3.868 0-7 3.132-7 7 0 3.867 3.132 7 7 7a6.977 6.977 0 0 0 4.875-1.975l.15-.15z"/></svg>
            </button>
        </div>
        <div class="actions-bar">
            <div class="list-actions">
                <div class="view-controls">
                    <span id="viewListBtn" class="view-btn" title="List View">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 4H21V6H3V4ZM3 11H21V13H3V11ZM3 18H21V20H3V18Z" /></svg>
                    </span>
                    <span id="viewGroupBtn" class="view-btn" title="Group View">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 3h8v8H3V3zM13 3h8v8h-8V3zM3 13h8v8H3v-8zM13 13h8v8h-8v-8z"/></svg>
                    </span>
                </div>
                <a href="#" id="toggleAllLink" style="display: none;"></a>
                <button id="quickLaunchBtn" title="Launch Favorite">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 18.26l-7.053 3.948 1.575-7.928L.587 8.792l8.027-.952L12 .5l3.386 7.34 8.027.952-5.935 5.488 1.575 7.928z"></path></svg>
                </button>
            </div>
            <div class="app-actions">
                <button id="addBtn" title="Add new link">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M11 11V5H13V11H19V13H13V19H11V13H5V11H11Z"></path></svg>
                </button>
            </div>
        </div>
        <ul id="linksList"></ul>
    </div>

    <div id="customPromptOverlay" class="custom-prompt-overlay" style="display: none;">
        <div class="custom-prompt-dialog">
            <p id="customPromptMessage"></p>
            <p id="customPromptError" class="custom-prompt-error"></p>
            <select id="customPromptSelect"></select>
            <input type="text" id="customPromptInput" placeholder="Or type a name/hex here">
            <div class="custom-prompt-actions">
                <button id="customPromptReset" class="secondary">Rabbit Me!</button>
                <div class="custom-prompt-actions-right">
                    <button id="customPromptCancel" class="secondary">Cancel</button>
                    <button id="customPromptOk">OK</button>
                </div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');
        const linksList = document.getElementById('linksList');
        const addBtn = document.getElementById('addBtn');
        const viewListBtn = document.getElementById('viewListBtn');
        const viewGroupBtn = document.getElementById('viewGroupBtn');
        const quickLaunchBtn = document.getElementById('quickLaunchBtn');
        const toggleAllLink = document.getElementById('toggleAllLink');
        const themeBtn = document.getElementById('themeBtn');
        const customPromptOverlay = document.getElementById('customPromptOverlay');
        const customPromptMessage = document.getElementById('customPromptMessage');
        const customPromptInput = document.getElementById('customPromptInput');
        const customPromptOk = document.getElementById('customPromptOk');
        const customPromptCancel = document.getElementById('customPromptCancel');
        const customPromptReset = document.getElementById('customPromptReset');
        const customPromptError = document.getElementById('customPromptError');
        const customPromptSelect = document.getElementById('customPromptSelect');

        const GENERIC_FAVICON_SRC = 'data:image/svg+xml,%3csvg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 24 24\' fill=\'%23888\'%3e%3cpath d=\'M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z\'/%3e%3c/svg%3e';

        /**
         * Launches a URL on the Rabbit r1 device, with a voice confirmation.
         * Includes a fallback for browser-based testing.
         * @param {string} url The URL to launch.
         * @param {string} name A descriptive name for the URL being launched.
         */
        async function launchUrlOnRabbit(url, name) {
            try {
                if (window.rabbit && window.rabbit.core) {
                    await window.rabbit.core.say({ text: `Launching ${name}` });
                    await window.rabbit.core.launchUrl({ url: url });
                } else {
                    console.log(`[Browser Mode] Launching: ${name} at ${url}`);
                    window.location.href = url;
                }
            } catch (error) {
                console.error("Error launching URL on Rabbit:", error);
                alert("Failed to launch URL.");
            }
        }

        /**
         * Triggers a short haptic vibration if on the Rabbit device.
         */
        function triggerHaptic() {
            try {
                if (window.rabbit && window.rabbit.core && window.rabbit.core.vibrate) {
                    window.rabbit.core.vibrate({ pattern: [50] }); // A short 50ms vibration
                }
            } catch (e) { console.error("Haptic feedback failed:", e); }
        }

        // Categories are sorted alphabetically, with 'Other' at the end for better usability.
        const categories = ['Education', 'Entertainment', 'Finance', 'Music', 'News', 'Shopping', 'Social', 'Sports', 'Tools', 'Travel', 'Other'];

        let links = JSON.parse(localStorage.getItem('launchPadR1Links')) || [
            { description: 'Youtube', url: 'https://m.youtube.com', category: 'Entertainment' },
            { description: 'Copilot', url: 'https://copilot.microsoft.com/', category: 'Tools' },
            { description: 'Radio.net', url: 'https://www.radio.net/', category: 'Music' }
        ];

        let currentView = localStorage.getItem('launchPadR1View') || 'list';
        let collapsedCategories = JSON.parse(localStorage.getItem('launchPadR1CollapsedCategories')) || [];
        let favoriteLinkIndex = parseInt(localStorage.getItem('launchPadR1FavoriteLinkIndex') || '-1', 10);
        let currentThemeName = localStorage.getItem('launchPadR1Theme') || 'rabbit';

        // Simple migration for old data without categories
        links.forEach(link => {
            if (!link.category) {
                link.category = 'Other';
            }
        });

        function updateToggleAllLinkState() {
            if (currentView !== 'group') {
                toggleAllLink.style.display = 'none';
                return;
            }
            
            // Get all unique categories from the complete, unfiltered `links` array.
            const allCategoriesInApp = [...new Set(links.map(link => link.category || 'Other'))];
            // Check if there is at least one category that is NOT in the collapsed list.
            const hasExpandedCategory = allCategoriesInApp.some(cat => !collapsedCategories.includes(cat));

            if (hasExpandedCategory) {
                toggleAllLink.textContent = 'Collapse All';
                toggleAllLink.style.display = 'block';
            } else {
                toggleAllLink.style.display = 'none';
            }
        }

        /**
         * Checks if any link descriptions are overflowing and applies a compact
         * style to the entire list if necessary to ensure uniformity.
         */
        function applyDynamicSizing() {
            const descriptions = linksList.querySelectorAll('.link-description');
            if (descriptions.length === 0) {
                linksList.classList.remove('small-text');
                return;
            }

            let isOverflowing = false;
            descriptions.forEach(desc => {
                // Check if the scrollWidth (actual content width) is greater than the clientWidth (visible area width)
                if (desc.scrollWidth > desc.clientWidth) {
                    isOverflowing = true;
                }
            });

            linksList.classList.toggle('small-text', isOverflowing);
        }

        function renderLinks(linksToRender = links) {
            // Set active icon
            viewListBtn.classList.toggle('active', currentView === 'list');
            viewGroupBtn.classList.toggle('active', currentView === 'group');

            // Reset dynamic sizing before rendering to ensure we start with the default large text.
            linksList.classList.remove('small-text');
            linksList.innerHTML = '';

            if (linksToRender.length === 0) {
                const query = searchInput.value.trim();
                if (query) {
                    linksList.innerHTML = `
                        <li class="link-item web-search-item">
                            <div class="link-description">🔍 Search web for "${query}"</div>
                        </li>
                    `;
                    linksList.querySelector('.web-search-item').addEventListener('click', () => fetchWebSuggestions(query));
                } else {
                    linksList.innerHTML = '<p style="text-align:center; color: #6c757d;">No links saved. Click "+ Add" to start.</p>';
                }
                return;
            }

            const groupedLinks = linksToRender.reduce((acc, link) => {
                const category = link.category || 'Other';
                if (!acc[category]) {
                    acc[category] = [];
                }
                acc[category].push(link);
                return acc;
            }, {});

            // Sort links within each category alphabetically by description
            for (const category in groupedLinks) {
                groupedLinks[category].sort((a, b) => a.description.localeCompare(b.description));
            }

            const sortedCategories = Object.keys(groupedLinks).sort((a, b) => {
                if (a === 'Other') return 1;
                if (b === 'Other') return -1;
                return a.localeCompare(b);
            });

            // Determine which category, if any, contains the favorite link.
            let favoriteCategory = null;
            if (favoriteLinkIndex !== -1 && links[favoriteLinkIndex]) {
                favoriteCategory = links[favoriteLinkIndex].category;
            }

            updateToggleAllLinkState();

            if (currentView === 'list') {
                sortedCategories.forEach(category => {
                    const categoryHeader = document.createElement('h3');
                    categoryHeader.className = 'category-header';
                    if (category === favoriteCategory) {
                        categoryHeader.innerHTML = `${category} <span class="favorite-indicator">★</span>`;
                    } else {
                        categoryHeader.textContent = category;
                    }
                    linksList.appendChild(categoryHeader);

                    groupedLinks[category].forEach(link => renderLinkItem(link, linksList, linksToRender));
                });
            } else { // Group View
                sortedCategories.forEach(category => {
                    const categoryHeader = document.createElement('h3');
                    categoryHeader.className = 'category-header collapsible';
                    if (category === favoriteCategory) {
                        categoryHeader.innerHTML = `${category} <span class="favorite-indicator">★</span>`;
                    } else {
                        categoryHeader.textContent = category;
                    }
                    linksList.appendChild(categoryHeader);
                    
                    const linksContainer = document.createElement('div');
                    linksContainer.className = 'links-container';
                    groupedLinks[category].forEach(link => renderLinkItem(link, linksContainer, linksToRender));
                    linksList.appendChild(linksContainer);

                    // Check if this category should be expanded or collapsed from memory
                    const isCollapsed = collapsedCategories.includes(category);
                    if (!isCollapsed) {
                        categoryHeader.classList.add('expanded');
                        linksContainer.classList.add('expanded');
                    }
                });
            }

            // After rendering, check for overflow. We use requestAnimationFrame to ensure
            // the browser has completed its layout calculations before we check element sizes,
            // preventing race conditions and ensuring accurate measurements.
            requestAnimationFrame(applyDynamicSizing);
        }

        /**
         * Extracts the hostname from a URL for favicon services.
         * @param {string} url The full URL.
         * @returns {string} The hostname (e.g., "www.google.com").
         */
        function getHostname(url) {
            try {
                return new URL(url).hostname;
            } catch (e) { return url; } // Fallback for invalid URLs
        }

        function renderLinkItem(link, parentElement, sourceArray = links) {
            // We need the original index from the main `links` array for editing/deleting
            const originalIndex = links.indexOf(link);
            if (originalIndex === -1) return; // Should not happen

            const li = document.createElement('li');
            li.className = 'link-item';
            li.dataset.index = originalIndex;
            li.innerHTML = `
                <img src="https://www.google.com/s2/favicons?sz=64&domain_url=${getHostname(link.url)}" class="link-favicon" alt="Favicon" onerror="this.onerror=null; this.src='${GENERIC_FAVICON_SRC}'; this.style.padding='3px';">
                <div class="link-display">
                    <div class="link-description">${link.description}</div>
                    <div class="link-actions">
                        <span class="favorite-btn" title="Set as favorite">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 18.26l-7.053 3.948 1.575-7.928L.587 8.792l8.027-.952L12 .5l3.386 7.34 8.027.952-5.935 5.488 1.575 7.928z"></path></svg>
                        </span>
                        <span class="edit-btn" title="Edit"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M15.7279 9.57627L14.3137 8.16206L5.82842 16.6473V18H7.18263L15.7279 9.57627ZM17.1421 8.16206L18.5563 6.74785L17.1421 5.33363L15.7279 6.74785L17.1421 8.16206ZM7.24264 20H3V15.7574L14.435 4.32233C14.8256 3.93181 15.4587 3.93181 15.8492 4.32233L19.6777 8.15076C20.0682 8.54128 20.0682 9.17445 19.6777 9.56497L8.24264 21H7.24264V20Z"></path></svg></span>
                        <span class="delete-btn" title="Delete"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M17 6H22V8H20V21C20 21.5523 19.5523 22 19 22H5C4.44772 22 4 21.5523 4 21V8H2V6H7V3C7 2.44772 7.44772 2 8 2H16C16.5523 2 17 2.44772 17 3V6ZM18 8H6V20H18V8ZM9 11H11V17H9V11ZM13 11H15V17H13V11ZM9 4V6H15V4H9Z"></path></svg></span>
                    </div>
                </div>
            `;
            // Style the favorite button if it's the current favorite
            if (originalIndex === favoriteLinkIndex) {
                li.querySelector('.favorite-btn').classList.add('is-favorite');
            }
            parentElement.appendChild(li);
        }

        function setView(view) {
            currentView = view;
            localStorage.setItem('launchPadR1View', view);
            renderLinks();
        }
        
        function saveLinks() {
            localStorage.setItem('launchPadR1Links', JSON.stringify(links));
        }

        function handleCategoryToggle(headerElement) {
            const linksContainer = headerElement.nextElementSibling;
            if (!linksContainer || !linksContainer.classList.contains('links-container')) return;

            linksContainer.classList.toggle('expanded');
            headerElement.classList.toggle('expanded');

            // Update and save the collapsed state
            const categoryName = headerElement.textContent.replace(' ★', '');
            const isNowExpanded = linksContainer.classList.contains('expanded');
            if (isNowExpanded) {
                collapsedCategories = collapsedCategories.filter(c => c !== categoryName);
            } else {
                if (!collapsedCategories.includes(categoryName)) {
                    collapsedCategories.push(categoryName);
                }
            }
            localStorage.setItem('launchPadR1CollapsedCategories', JSON.stringify(collapsedCategories));
            updateToggleAllLinkState();
        }

        function handleDeleteLink(index) {
            if (confirm(`Are you sure you want to delete "${links[index].description}"?`)) {
                links.splice(index, 1);
                // If the deleted link was the favorite, reset it.
                if (favoriteLinkIndex === index) {
                    favoriteLinkIndex = -1;
                    localStorage.setItem('launchPadR1FavoriteLinkIndex', '-1');
                }
                saveLinks();
                // Re-apply the current filter to show the updated list
                // without losing the user's search context.
                handleFilter();
            }
        }

        function handleLaunchLink(li, index) {
            // If the item is in edit mode (has an edit input), do not launch.
            if (li.querySelector('.edit-description')) {
                return;
            }
            const link = links[index];
            triggerHaptic();
            launchUrlOnRabbit(link.url, link.description);
        }

        linksList.addEventListener('click', async (e) => {
            const target = e.target;
            const li = target.closest('.link-item');

            // Handle category collapse/expand in 'group' view
            const categoryHeader = target.closest('.category-header.collapsible');
            if (currentView === 'group' && categoryHeader) {
                handleCategoryToggle(categoryHeader);
                return;
            }

            if (!li) return;
            const index = parseInt(li.dataset.index);

            if (target.closest('.delete-btn')) {
                handleDeleteLink(index);
            } else if (target.closest('.edit-btn')) {
                editLink(li, index);
            } else if (target.closest('.favorite-btn')) {
                // If the clicked link is already the favorite, unfavorite it.
                if (favoriteLinkIndex === index) {
                    favoriteLinkIndex = -1;
                } else {
                    favoriteLinkIndex = index;
                }
                localStorage.setItem('launchPadR1FavoriteLinkIndex', favoriteLinkIndex);
                handleFilter(); // Re-render to show the new favorite state
            } else if (target.closest('.link-display') || target.closest('.link-favicon')) {
                handleLaunchLink(li, index);
            }
        });

        /**
         * Creates the HTML for the add/edit form.
         * @param {object|null} link - The link object to edit, or null for a new link.
         * @returns {string} The innerHTML for the form.
         */
        function createFormHTML(linkData = {}, isForEditing = false) {
            const description = linkData.description || '';
            const url = linkData.url || 'https://';
            const selectedCategory = linkData.category || 'Other';

            const categoryOptions = categories.map(cat => 
                `<option value="${cat}" ${selectedCategory === cat ? 'selected' : ''}>${cat}</option>`
            ).join('');

            const inputClassPrefix = isForEditing ? 'edit' : 'new';
            const saveButtonClass = isForEditing ? 'save-btn' : 'save-new-btn';

            return `
                <div class="link-info">
                    <input type="text" class="${inputClassPrefix}-description" value="${description}" placeholder="Description">
                    <div class="input-with-action">
                        <input type="text" class="${inputClassPrefix}-url" value="${url}" placeholder="URL (e.g., https://...)">
                        <button class="fetch-title-btn" title="Fetch Title"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12.0006 22.0001L8.89941 18.8989L12.0006 15.7977L13.4148 17.2119L12.0006 18.6261L14.8289 21.4544L12.0006 22.0001ZM12.0006 8.20237L10.5864 6.78816L12.0006 5.37395L15.1018 8.47512L12.0006 11.5763L10.5864 10.1621L12.0006 8.74789V8.20237ZM2.94971 13.0503L6.78812 10.5865L8.20234 12.0007L5.37402 14.829L2.39941 12.0007L2.94971 13.0503ZM18.8994 5.10059L17.2121 6.78784L18.6263 8.20206L21.6009 5.37378L18.8994 5.10059ZM8.89941 5.10059L2.39941 12.0007L5.17157 14.8288L12.0006 8.00012L8.89941 5.10059ZM15.1018 18.8989L21.6009 12.0007L18.8287 9.1724L12.0006 16.0001L15.1018 18.8989Z"></path></svg></button>
                    </div>
                    <select class="${inputClassPrefix}-category">${categoryOptions}</select>
                    <div class="form-actions">
                        <button class="cancel-btn secondary">Cancel</button>
                        <button class="${saveButtonClass}">${isForEditing ? 'Save' : 'Add'}</button>
                    </div>
                </div>
            `;
        }

        async function fetchTitle(urlInput, descriptionInput, button) {
            const targetUrl = urlInput.value.trim();
            // Make the check case-insensitive to handle inputs like 'Https://'
            if (!targetUrl || !targetUrl.toLowerCase().startsWith('http')) {
                alert('Please enter a valid URL starting with http or https.');
                return;
            }

            button.disabled = true;
            const originalText = descriptionInput.value;
            descriptionInput.value = 'Fetching title...';

            // Use a powerful proxy API (microlink.io) which is better at handling various sites.
            const proxyUrl = `https://api.microlink.io/?url=${encodeURIComponent(targetUrl)}`;

            try {
                const response = await fetch(proxyUrl);
                if (!response.ok) throw new Error(`Network response was not ok: ${response.statusText}`);
                
                const data = await response.json();

                // Microlink's response structure is { status: 'success', data: { title: '...' } }
                if (data && data.status === 'success' && data.data && data.data.title) {
                    let fullTitle = data.data.title.trim();
                    let finalTitle = fullTitle;

                    // Use a regular expression to split by any common separator,
                    // handling optional spaces around it for more robust parsing.
                    const parts = fullTitle.split(/\s*(-|\||–|—|:)\s*/);
                    if (parts.length > 1) {
                        finalTitle = parts[0].trim();
                    }
                    descriptionInput.value = finalTitle;
                } else {
                    descriptionInput.value = originalText; // Restore original if no title found
                    alert('Title not found.');
                }
            } catch (e) {
                console.error("Fetch title error:", e);
                descriptionInput.value = originalText; // Restore on error
                alert('Could not fetch title. The website may be blocking requests.');
            } finally {
                button.disabled = false;
            }
        }

        async function fetchWebSuggestions(query) {
            linksList.innerHTML = '<p style="text-align:center; color: #6c757d;">Searching the web...</p>';
            try {
                // We will fetch the simple HTML version of DuckDuckGo's search results
                // and parse it ourselves to get high-quality, relevant links.
                const searchUrl = `https://html.duckduckgo.com/html/?q=${encodeURIComponent(query)}`;
                
                // This direct fetch will fail in local browsers due to CORS, but is designed
                // to work on the Rabbit R1 device with the core:fetch permission.
                const response = await fetch(searchUrl);
                if (!response.ok) throw new Error('Network error');

                const htmlContent = await response.text();

                const parser = new DOMParser();
                const doc = parser.parseFromString(htmlContent, 'text/html');
                const results = [];
                // The class 'result__a' is what DDG's HTML version uses for its main result links.
                doc.querySelectorAll('.result__a').forEach(link => {
                    results.push({
                        text: link.textContent.trim(),
                        url: new URL(link.href).searchParams.get('uddg') // Extract the real URL
                    });
                });

                renderWebSuggestions(results.filter(r => r.url)); // Filter out any invalid results
            } catch (e) {
                console.error("Web suggestion fetch error:", e);
                const errorMsg = e.message.includes('Failed to fetch') 
                    ? 'Could not fetch suggestions. (This is expected in local browsers due to CORS. Please test on device.)'
                    : 'Could not fetch suggestions. Please try again.';
                linksList.innerHTML = `<p class="error-message">${errorMsg}</p>`;
            }
        }

        function renderWebSuggestions(results) {
            linksList.innerHTML = '';
            if (results.length === 0) {
                linksList.innerHTML = `<p style="text-align:center; color: #6c757d;">No web suggestions found.</p>`;
                return;
            }

            results.slice(0, 5).forEach(result => { // Limit to 5 suggestions
                const li = document.createElement('li');
                li.className = 'link-item web-suggestion';
                li.innerHTML = `
                    <img src="https://www.google.com/s2/favicons?sz=64&domain_url=${getHostname(result.url)}" class="link-favicon" alt="Favicon" onerror="this.onerror=null; this.src='${GENERIC_FAVICON_SRC}'; this.style.padding='3px';">
                    <div class="link-display">
                        <div class="link-description">${result.text}</div>
                        <div class="link-actions">
                            <button class="add-suggestion-btn">+</button>
                        </div>
                    </div>
                `;
                li.querySelector('.add-suggestion-btn').addEventListener('click', () => {
                    showAddForm({ description: result.text.split(/\s*(-|\||–|—|:)\s*/)[0], url: result.url, category: 'Other' });
                });
                linksList.appendChild(li);
            });
        }

        function editLink(li, index) {
            const link = links[index];
            // Temporarily remove the favicon during edit to maximize space
            li.innerHTML = createFormHTML(link, true);

            li.querySelector('.save-btn').addEventListener('click', () => {
                const newDescription = li.querySelector('.edit-description').value.trim();
                const newUrl = li.querySelector('.edit-url').value.trim();
                const newCategory = li.querySelector('.edit-category').value;
                if (newDescription && newUrl) {
                    links[index] = {
                        description: newDescription,
                        url: newUrl,
                        category: newCategory
                    };
                    saveLinks();
                    handleFilter(); // Re-apply filter to show the change
                } else {
                    alert('Description and URL cannot be empty.');
                }
            });
            li.querySelector('.cancel-btn').addEventListener('click', () => {
                handleFilter(); // Re-render the list to cancel, respecting filter
            });

            const urlInput = li.querySelector('.edit-url');
            const descriptionInput = li.querySelector('.edit-description');
            const fetchBtn = li.querySelector('.fetch-title-btn');
            fetchBtn.addEventListener('click', () => fetchTitle(urlInput, descriptionInput, fetchBtn));
        }

        function showAddForm(prefillData = {}) {
            // Prevent adding another new item if one is already being added
            const existingNewInput = document.querySelector('.new-description');
            if (existingNewInput) {
                const existingForm = existingNewInput.closest('.link-item');
                // If there's prefill data, update the existing blank form
                if (prefillData.description) {
                    existingForm.querySelector('.new-description').value = prefillData.description;
                }
                if (prefillData.url) {
                    existingForm.querySelector('.new-url').value = prefillData.url;
                }
                existingForm.querySelector('.new-description').focus();
                return;
            }

            const li = document.createElement('li');
            li.className = 'link-item';
            li.innerHTML = createFormHTML(prefillData, false);
            linksList.appendChild(li);

            // Scroll to the new item and focus the description input
            li.scrollIntoView({ behavior: 'smooth' });
            // Focus the most relevant input based on what's pre-filled
            if (prefillData.description && prefillData.url && prefillData.url !== 'https://') {
                // If both are pre-filled (quick-add), focus category for quick change.
                li.querySelector('.new-category').focus();
            } else if (prefillData.description) {
                // If only description is pre-filled (complex query), focus URL for entry.
                li.querySelector('.new-url').focus();
            } else {
                // If nothing is pre-filled (manual add), focus description.
                li.querySelector('.new-description').focus();
            }

            const saveHandler = () => {
                const description = li.querySelector('.new-description').value.trim();
                const url = li.querySelector('.new-url').value.trim();
                const category = li.querySelector('.new-category').value;
                addNewLink({ description, url, category });
            };

            li.querySelector('.save-new-btn').addEventListener('click', saveHandler);
            li.querySelector('.cancel-btn').addEventListener('click', () => {
                li.remove();
                searchInput.value = '';
                handleFilter(); // Re-render full list
            });

            const urlInput = li.querySelector('.new-url');
            const descriptionInput = li.querySelector('.new-description');
            const fetchBtn = li.querySelector('.fetch-title-btn');
            fetchBtn.addEventListener('click', () => fetchTitle(urlInput, descriptionInput, fetchBtn));
        }

        addBtn.addEventListener('click', () => showAddForm());

        function handleAddFromQuery(query) {
            if (!query) return;

            // Clear the "Add..." suggestion from the list before showing the form.
            linksList.innerHTML = '';

            const hasSpaces = query.includes(' ');
            let prefillData = {};

            if (hasSpaces) {
                // For complex queries, just pre-fill the description.
                prefillData = {
                    description: query.replace(/\b\w/g, l => l.toUpperCase()),
                    url: 'https://'
                };
            } else {
                // For simple queries, pre-fill both description and a guessed URL.
                const hasProtocol = query.startsWith('http://') || query.startsWith('https://');
                const looksLikeDomain = query.includes('.');
                const url = hasProtocol ? query : (looksLikeDomain ? `https://${query}` : `https://www.${query}.com`);
                const description = query.split('.')[0].replace(/^(https?:\/\/)?(www\.)?/, '').replace(/\b\w/g, l => l.toUpperCase());
                prefillData = { description, url, category: 'Other' };
            }
            
            showAddForm(prefillData);
        }

        /**
         * Adds a new link to the list, saves it, and refreshes the UI.
         * @param {object} linkData - The link object to add.
         * @returns {boolean} - True if the link was added, false otherwise.
         */
        function addNewLink(linkData) {
            if (!linkData || !linkData.description || !linkData.url || linkData.url === 'https://') {
                alert('Please provide a description and a full URL.');
                return false;
            }
            links.push(linkData);
            saveLinks();
            searchInput.value = '';
            renderLinks();

            // Provide auditory feedback on the device
            try {
                if (window.rabbit && window.rabbit.core) {
                    window.rabbit.core.say({ text: `Added ${linkData.description}` });
                }
            } catch (e) { console.error("Say feedback failed:", e); }
            return true;
        }

        function performExternalSearch(queryOverride) {
            const query = queryOverride || searchInput.value.trim();
            if (query) {
                const searchUrl = `https://duckduckgo.com/?q=${encodeURIComponent(query)}`;
                launchUrlOnRabbit(searchUrl, `search for ${query}`);
                searchInput.value = '';
            }
            handleFilter(); // Clear filter after searching
        }

        function handleFilter() {
            const query = searchInput.value.trim().toLowerCase();
            if (!query) {
                renderLinks(links); // Render all links if query is empty
                return;
            }
            const filteredLinks = links.filter(link => 
                link.description.toLowerCase().includes(query) ||
                link.url.toLowerCase().includes(query)
            );
            renderLinks(filteredLinks);
        }

        searchBtn.addEventListener('click', () => performExternalSearch());
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                performExternalSearch();
            }
        });
        searchInput.addEventListener('input', handleFilter);

        viewListBtn.addEventListener('click', () => setView('list'));
        viewGroupBtn.addEventListener('click', () => setView('group'));

        toggleAllLink.addEventListener('click', (e) => {
            e.preventDefault();
            
            // Get all unique categories from the complete, unfiltered `links` array.
            const allCategoriesInApp = [...new Set(links.map(link => link.category || 'Other'))];

            // The link only appears when there's something to collapse, so its only action is to collapse all.
            collapsedCategories = [...allCategoriesInApp];
            localStorage.setItem('launchPadR1CollapsedCategories', JSON.stringify(collapsedCategories));
            handleFilter(); // Re-render respecting the current search query
        });

        // --- Quick Launch Event Listener ---
        quickLaunchBtn.addEventListener('click', () => {
            if (favoriteLinkIndex >= 0 && favoriteLinkIndex < links.length) {
                const favoriteLink = links[favoriteLinkIndex];
                triggerHaptic();
                launchUrlOnRabbit(favoriteLink.url, favoriteLink.description);
            } else {
                if (window.rabbit && window.rabbit.core) {
                    window.rabbit.core.say({ text: "No favorite link set." });
                } else {
                    alert("No favorite link set. Click the star on a link to set it as a favorite.");
                }
            }
        });

        // --- Theming & Custom Prompt ---
        function showCustomPrompt(message) {
            return new Promise((resolve) => {
                customPromptMessage.textContent = message;
                customPromptInput.value = '';
                customPromptSelect.value = ''; // Reset dropdown
                customPromptOverlay.style.display = 'flex';
                customPromptInput.focus();

                let resolved = false; // Prevent multiple resolutions

                const closePrompt = (value) => {
                    if (resolved) return;
                    resolved = true;
                    
                    customPromptOverlay.style.display = 'none';
                    customPromptOk.onclick = null;
                    customPromptCancel.onclick = null;
                    customPromptOverlay.onclick = null;
                    customPromptReset.onclick = null;
                    customPromptInput.onkeypress = null;
                    resolve(value);
                };

                customPromptOk.onclick = () => closePrompt(customPromptInput.value);
                customPromptCancel.onclick = () => closePrompt(null);
                customPromptOverlay.onclick = (e) => {
                    if (e.target === customPromptOverlay) closePrompt(null);
                };
                customPromptReset.onclick = () => closePrompt('reset');
                customPromptInput.onkeypress = (e) => {
                    if (e.key === 'Enter') closePrompt(customPromptInput.value);
                };
            });
        }

        const CSS_COLOR_NAMES = ['AliceBlue', 'AntiqueWhite', 'Aqua', 'Aquamarine', 'Azure', 'Beige', 'Bisque', 'Black', 'BlanchedAlmond', 'Blue', 'BlueViolet', 'Brown', 'BurlyWood', 'CadetBlue', 'Chartreuse', 'Chocolate', 'Coral', 'CornflowerBlue', 'Cornsilk', 'Crimson', 'Cyan', 'DarkBlue', 'DarkCyan', 'DarkGoldenRod', 'DarkGray', 'DarkGreen', 'DarkKhaki', 'DarkMagenta', 'DarkOliveGreen', 'DarkOrange', 'DarkOrchid', 'DarkRed', 'DarkSalmon', 'DarkSeaGreen', 'DarkSlateBlue', 'DarkSlateGray', 'DarkTurquoise', 'DarkViolet', 'DeepPink', 'DeepSkyBlue', 'DimGray', 'DodgerBlue', 'FireBrick', 'FloralWhite', 'ForestGreen', 'Fuchsia', 'Gainsboro', 'GhostWhite', 'Gold', 'GoldenRod', 'Gray', 'Green', 'GreenYellow', 'HoneyDew', 'HotPink', 'IndianRed', 'Indigo', 'Ivory', 'Khaki', 'Lavender', 'LavenderBlush', 'LawnGreen', 'LemonChiffon', 'LightBlue', 'LightCoral', 'LightCyan', 'LightGoldenRodYellow', 'LightGray', 'LightGreen', 'LightPink', 'LightSalmon', 'LightSeaGreen', 'LightSkyBlue', 'LightSlateGray', 'LightSteelBlue', 'LightYellow', 'Lime', 'LimeGreen', 'Linen', 'Magenta', 'Maroon', 'MediumAquaMarine', 'MediumBlue', 'MediumOrchid', 'MediumPurple', 'MediumSeaGreen', 'MediumSlateBlue', 'MediumSpringGreen', 'MediumTurquoise', 'MediumVioletRed', 'MidnightBlue', 'MintCream', 'MistyRose', 'Moccasin', 'NavajoWhite', 'Navy', 'OldLace', 'Olive', 'OliveDrab', 'Orange', 'OrangeRed', 'Orchid', 'PaleGoldenRod', 'PaleGreen', 'PaleTurquoise', 'PaleVioletRed', 'PapayaWhip', 'PeachPuff', 'Peru', 'Pink', 'Plum', 'PowderBlue', 'Purple', 'RebeccaPurple', 'Red', 'RosyBrown', 'RoyalBlue', 'SaddleBrown', 'Salmon', 'SandyBrown', 'SeaGreen', 'SeaShell', 'Sienna', 'Silver', 'SkyBlue', 'SlateBlue', 'SlateGray', 'Snow', 'SpringGreen', 'SteelBlue', 'Tan', 'Teal', 'Thistle', 'Tomato', 'Turquoise', 'Violet', 'Wheat', 'White', 'WhiteSmoke', 'Yellow', 'YellowGreen'].sort();

        function setupColorPicker() {
            const select = customPromptSelect;
            select.innerHTML = '<option value="">Select a color...</option>';
            CSS_COLOR_NAMES.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                select.appendChild(option);
            });

            select.addEventListener('change', () => {
                customPromptError.textContent = ''; // Clear error on selection
                if (select.value) {
                    customPromptInput.value = select.value;
                    customPromptOk.focus(); // Guide user to the next step
                }
            });

            // Also clear the error when the user starts typing a new value
            customPromptInput.addEventListener('input', () => {
                customPromptError.textContent = '';
            });
        }

        const defaultTheme = { name: 'Rabbit', colors: { '--primary-color': '#ff7043', '--bg-color': '#0d0d0d', '--item-bg': '#1c1c1c', '--border-color': '#2a2a2a', '--icon-color': '#7a7a7a' } };

        function colorNameToRgb(name) {
            const el = document.createElement('div');
            // Set a known, unique color that is unlikely to be the result of a valid name.
            const magicColor = 'rgb(1, 2, 3)';
            el.style.color = magicColor; 
            document.body.appendChild(el);

            // Now, try to set the user's color.
            el.style.color = name;
            const computedColor = window.getComputedStyle(el).color;
            
            document.body.removeChild(el);

            // If the computed color is still our magic color, the name was invalid.
            if (computedColor === magicColor || computedColor === 'rgba(0, 0, 0, 0)' || computedColor === 'transparent') return null;

            const rgb = computedColor.match(/\d+/g).map(Number);
            return rgb;
        }

        function rgbToHsl(r, g, b) {
            r /= 255; g /= 255; b /= 255;
            const max = Math.max(r, g, b), min = Math.min(r, g, b);
            let h, s, l = (max + min) / 2;
            if (max === min) { h = s = 0; } else {
                const d = max - min;
                s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                switch (max) {
                    case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                    case g: h = (b - r) / d + 2; break;
                    case b: h = (r - g) / d + 4; break;
                }
                h /= 6;
            }
            return [h, s, l];
        }

        function hslToRgb(h, s, l) {
            let r, g, b;
            if (s === 0) { r = g = b = l; } else {
                const hue2rgb = (p, q, t) => {
                    if (t < 0) t += 1; if (t > 1) t -= 1;
                    if (t < 1 / 6) return p + (q - p) * 6 * t;
                    if (t < 1 / 2) return q;
                    if (t < 2 / 3) return p + (q - p) * (2 / 3 - t) * 6;
                    return p;
                };
                const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
                const p = 2 * l - q;
                r = hue2rgb(p, q, h + 1 / 3); g = hue2rgb(p, q, h); b = hue2rgb(p, q, h - 1 / 3);
            }
            return `rgb(${Math.round(r * 255)}, ${Math.round(g * 255)}, ${Math.round(b * 255)})`;
        }

        function generatePaletteFromRgb(rgb) {
            const [r, g, b] = rgb;
            if (r < 30 && g < 30 && b < 30) return null;
            const [h, s, l] = rgbToHsl(r, g, b);
            return {
                '--primary-color': `rgb(${r}, ${g}, ${b})`,
                '--bg-color': hslToRgb(h, s * 0.5, 0.07),
                '--item-bg': hslToRgb(h, s * 0.6, 0.12),
                '--border-color': hslToRgb(h, s * 0.6, 0.18),
                '--icon-color': hslToRgb(h, s * 0.3, 0.5)
            };
        }

        async function applyTheme(themeIdentifier) {
            let themeColors;
            let friendlyName;

            if (themeIdentifier.startsWith('custom:')) {
                const colorName = themeIdentifier.split(':')[1];
                const primaryRgb = colorNameToRgb(colorName);
                if (!primaryRgb) {
                    customPromptError.textContent = `'${colorName}' is not a recognized name. Try a hex code.`;
                    return false;
                }
                themeColors = generatePaletteFromRgb(primaryRgb);
                if (!themeColors) {
                    customPromptError.textContent = "This color is too dark. Please choose a lighter color.";
                    return false;
                }
                friendlyName = colorName;
            } else {
                themeColors = defaultTheme.colors;
                friendlyName = defaultTheme.name;
            }

            if (!themeColors) return true; // Should not happen, but don't block the loop.

            // If we've reached here, the color is valid, so clear any previous error messages.
            customPromptError.textContent = '';

            for (const [key, value] of Object.entries(themeColors)) {
                document.documentElement.style.setProperty(key, value);
            }
            currentThemeName = themeIdentifier;
            localStorage.setItem('launchPadR1Theme', themeIdentifier);

            // Provide feedback
            try {
                if (window.rabbit && window.rabbit.core) {
                    await window.rabbit.core.say({ text: `Theme set to ${friendlyName}` });
                }
            } catch (e) { console.error("Say feedback failed:", e); }
            return true;
        }

        async function openThemeEditor() {
            let success = false;
            // Clear any errors from a previous session before starting.
            if (customPromptError) customPromptError.textContent = '';

            while (!success) {
                const result = await showCustomPrompt("Enter a color, hex, or select one:");

                if (result === 'reset') {
                    await applyTheme('rabbit');
                    success = true; // Exit loop after resetting
                } else if (result && result.trim()) {
                    let colorInput = result.trim();
                    let colorToApply = colorInput;

                    // More robust hex detection: strip an optional '#' and then validate.
                    const potentialHex = colorInput.startsWith('#') ? colorInput.substring(1) : colorInput;
                    if (/^[0-9a-f]{3}([0-9a-f]{3})?$/i.test(potentialHex)) {
                        colorToApply = '#' + potentialHex;
                    }

                    // Try to apply the theme. If it succeeds, the loop will exit.
                    // If it fails, the error message is set by applyTheme, and the loop continues.
                    success = await applyTheme(`custom:${colorToApply}`);
                } else {
                    // User cancelled, so we exit the loop.
                    success = true;
                }
            }
        }

        // --- Initial Load ---
        
        setupColorPicker();
        // Apply the initial theme
        applyTheme(currentThemeName);
        
        renderLinks();

    });
    </script>
</body>
</html>